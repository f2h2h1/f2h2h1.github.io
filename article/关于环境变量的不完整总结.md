# 关于环境变量的不完整总结

## 环境变量是什么

环境变量（environment variables）

- 现代操作系统都有环境变量
- 环境变量是键值对
- 环境变量的 键 值 都是字符串
- 程序可以通过系统 API 访问环境变量
- 环境变量 最早出现在 Version 7 Unix ，然后后续的操作系统都继承了这样的设计
- 环境变量是进程运行环境的一部分
    - 例如，正在运行的进程可以查询 TEMP 环境变量的值以发现存储临时文件的合适位置，
    - 或者查询 HOME 或 USERPROFILE 变量的值以查找运行该进程的用户所拥有的目录结构。
- 每个进程都有自己单独的环境变量
- 环境变量可以修改，但一般只能在当前进程或子进程生效
- 环境变量由父进程设置
    - 默认情况下会复制父进程的环境变量
    - 父进程也可以单独地设置子进程的环境变量
- 环境变量的作用
    - 让进程知道当前的运行环境
    - 把数据传递给子进程
    - 存储临时数据
- 环境变量的作用域
    - 当前进程
        - 当前终端的环境变量实质上就是当前 shell 的环境变量，也是进程的作用域
    - 当前用户
    - 全局
- 常见的环境变量
    - PATH: 列出 shell 搜索 用户 输入的执行命令所在的目录。
    - HOME: (类Unix系统) 和 userprofile (Microsoft Windows) 表示用户的家目录在文件系统中的位置。
    - TEMP: 进程可以存储临时文件的位置。
    - JAVA_HOME: jdk 目录的路径
- 伪环境变量 pseudo environment variables
    - 并不真正存储在环境中，而是在请求时计算的
    - 例如 %CD% %DATE%

在 Unix 系统通过初始化脚本启动时，环境变量通常会在此时被初始化，因此会被系统中的其它进程所继承。
在 Windows 系统中，环境变量存储在 Windows 注册表中。

## 在 cmd 里操作环境变量

1. 查看全部环境变量
    ```
    set
    ```
1. 设置环境变量
    ```
    set example=testvar
    ```
1. 输出环境变量
    ```
    echo $path
    ```
    - 访问环境变量和访问普通变量是一样的
    - 环境变量名大小写不敏感
1. 删除环境变量
    ```
    set example=
    ```
1. 修改环境变量
    - 可以直接覆盖原本的环境变量
    - 可以先删除再新建
1. 给 path 添加新的路径
    ```
    set path=%path%;C:\Tools
    ```

cmd 里修改环境变量只影响当前的进程

## 在 powershell 里操作环境变量

PowerShell 提供了几种不同的方法来使用和管理环境变量

### 使用 variable 语法

1. 查看全部环境变量
    ```
    ls Env:
    ```
1. 设置环境变量
    ```
    $Env:example = "testvar"
    ```
1. 输出环境变量
    ```
    echo $Env:example
    ```
    - 访问环境变量和访问普通变量是一样的
    - 环境变量名大小写不敏感
1. 删除环境变量
    ```
    del Env:example
    ```
1. 修改环境变量
    - 可以直接覆盖原本的环境变量
    - 可以先删除再新建
1. 给 path 添加新的路径
    ```
    $Env:Path += ';C:\Tools'
    ```

### cmdlet

1. 查看全部环境变量
    ```
    Get-Item -Path Env:\*
    ```
1. 设置环境变量
    ```
    New-Item -Path Env: -Name example -Value 'testvar'
    或
    Set-Item -Path Env:example -Value 'testvar'
    ```
1. 输出环境变量
    ```
    Get-Item -Path Env:\example
    Get-Item -Path Env:\example | Select-Object -Property Value
    Get-Item -Path Env:\example | Select-Object -ExpandProperty Value
    ```
1. 删除环境变量
    ```
    Remove-Item -Path Env:example
    ```
1. 修改环境变量
    ```
    修改值
    Set-Item -Path Env:example -Value 'testvar2'
    重命名
    Rename-Item -Path Env:example -NewName example
    ```
1. 给 path 添加新的路径
    ```
    Set-Item -Path Env:\Path -Value $Env:Path';C:\Tools'
    Set-Item -Path Env:\Path -Value ((Get-Item -Path Env:\Path | Select-Object -ExpandProperty Value)+';C:\Tools')
    ```

### .NET 类

1. 查看全部环境变量
    ```
    [Environment]::GetEnvironmentVariables()
    ```
1. 设置环境变量
    ```
    [Environment]::SetEnvironmentVariable('example', 'testvar')
    ```
1. 输出环境变量
    ```
    [Environment]::GetEnvironmentVariable('example')
    ```
1. 删除环境变量
    ```
    [Environment]::SetEnvironmentVariable('example', '')
    ```
1. 修改环境变量
    - 可以直接覆盖原本的环境变量
    - 可以先删除再新建
1. 给 path 添加新的路径
    ```
    Set-Item -Path Env:\Path -Value $Env:Path';C:\Tools'
    Set-Item -Path Env:\Path -Value ((Get-Item -Path Env:\Path | Select-Object -ExpandProperty Value)+';C:\Tools')
    ```

### 保存环境变量的修改

Environment 能修改全局的或当前用户的环境变量，其它两种方法在默认情况下都是修改当前进程的环境变量。修改全局的环境变量可能会遇到权限的问题。
```
[Environment]::SetEnvironmentVariable('example', 'testvar', [EnvironmentVariableTarget]::Process)
[Environment]::SetEnvironmentVariable('example', 'testvar', [EnvironmentVariableTarget]::User)
[Environment]::SetEnvironmentVariable('example', 'testvar', [EnvironmentVariableTarget]::Machine)
```

<!--

[EnvironmentVariableTarget].GetEnumNames()
[EnvironmentVariableTarget].GetEnumValues()
[EnvironmentVariableTarget].GetEnumName(0)
[EnvironmentVariableTarget].GetEnumNames() | ForEach-Object {
  "{0,-10} {1}" -f $_,[int]([EnvironmentVariableTarget]::$_)
}
[EnvironmentVariableTarget]::Process
[EnvironmentVariableTarget]::User
[EnvironmentVariableTarget]::Machine

-->

在 windows 修改环境变量最保险的方式还是通过这里修改
```
此电脑 -> 属性 -> 高级系统设置 -> 环境变量
```

## 在 bash 里操作环境变量

1. 查看全部环境变量
    ```
    printenv
    或
    export -p
    ```
1. 设置环境变量
    ```
    export example=testvar
    ```
1. 输出环境变量
    ```
    echo $path
    或
    printenv path
    ```
    - 访问环境变量和访问普通变量是一样的
    - 环境变量名大小写敏感
1. 删除环境变量
    ```
    export -n example
    ```
1. 修改环境变量
    - 可以直接覆盖原本的环境变量
    - 可以先删除再新建
1. 给 path 添加新的路径
    ```
    export PATH=$PATH:/usr/local/nginx/sbin
    ```
    - 在 Linux 或 macOS 上，使用冒号 (:) 而不是分号 (;)

### 保存环境变量的修改

- bash 修改的环境变量只在当前 shell 有效， shell 关闭后就会失效
- 修改用户的环境变量
    1. 修改这个文件
        ```
        ~/.bashrc
        ```
    1. 修改环境变量时，大致需要这样修改，因为是脚本文件所以就是在脚本里添加 export 命令来修改环境变量
        ```
        # 添加一个新的环境变量
        export example=testvar
        # 给 path 添加新的路径
        export PATH=$PATH:/usr/local/nginx/sbin
        ```
    1. 修改 ~/.bashrc 后，运行这句命令就能生效
        ```
        source ~/.bashrc
        ```
- 修改系统的环境变量
    1. 修改这个文件
        ```
        /etc/bashrc (redhat)
        /etc/bash.bashrc (debian)
        ```
    1. 又或者直接修改这个文件 /etc/environment
        - /etc/environment 是纯文本文件，不是脚本，不能用变量
        - /etc/bash.bashrc ， /etc/profile 这类是 shell 脚本
    1. 修改系统的环境变量则需要重启系统才能生效
    1. 修改这个文件 /etc/profile 也可以达到类似的效果
        - /etc/profile 是用户登录时执行的脚本
        -  ~~（但这里其实是有一点坑的，因为有些 shell 脚本执行时可能不需要登录用户）~~
- liunx 环境变量的修改本质上是修改各种配置脚本
    - 各种配置脚本有不一样的加载顺序 ~~（各种配置脚本的作用和加载顺序也是一个大坑，可以另外写一篇笔记）~~
    - 各种配置脚本在不同的发行版里可能会有不同的文件名

## 在 c 语言里操作环境变量

c 里有一系列的函数来操作环境变量
```
char *getenv(const char *name);
int putenv(char *string);
int setenv(const char *envname, const char *envval, int overwrite);
int unsetenv(const char *name);
char *secure_getenv(const char *name);
int clearenv(void);
```
- 这些函数都在在头文件 stdlib.h 中声明
- 全局变量 char **environ 和 main 函数的第三个参数 char\* envp[] 都保存有完整的环境变量
    - 全局变量 char **environ 在头文件 unistd.h 中声明
- 只有 getenv 是 ascii c
- 其它的是来自 posix 或 sus 或 gun c，笔者没多少心思区分哪个函数来自哪个标准，反正用 gcc 编译时都能用。

<!--
只有 getenv 是 ascii c
putenv, setenv, unsetenv 这三个函数和 environ envp 都是来自 posix
secure_getenv 和 clearenv 来自 gun c
-->

例子
```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
extern char**environ;
int main(int argc, char* argv[], char* envp[])
{
    for (int i = 0; envp[i] != NULL; ++i)
    {
        printf("%s\n", envp[i]);
    }
	printf("****\n");

    for (char **var = environ; *var != NULL; ++var)
	{
        printf("%s\n", *var);
	}
	printf("****\n");
	
	printf("%s\n", getenv("PATH"));
	printf("****\n");
	
	putenv("TEST=123");
	printf("%s\n", getenv("TEST"));
	printf("****\n");

	int overwrite = 1;
	setenv("TEST", "321", overwrite);
	printf("%s\n", getenv("TEST"));
	printf("****\n");
	
	unsetenv("TEST");

	clearenv();

    return 0;
}
```

其它语言操作环境变量也会有相应的语法，只要看一下文档就好了。

## 查看某个进程的环境变量

- linux
    ```
    cat /proc/<pid>/environ
    cat /proc/360/environ
    cat /proc/25999/environ | tr '\0' '\n'
    ```
- windows
    - 使用这个工具 https://docs.microsoft.com/zh-cn/sysinternals/downloads/process-explorer


## 参考

- https://en.wikipedia.org/wiki/Environment_variable
- https://en.cppreference.com/w/c/program/getenv
- https://pubs.opengroup.org/onlinepubs/009696899/basedefs/xbd_chap08.html
- https://man7.org/linux/man-pages/man3/clearenv.3.html
- https://docs.microsoft.com/zh-cn/windows-server/administration/windows-commands/set_1
- https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_environment_provider?view=powershell-7.2
- https://docs.microsoft.com/zh-cn/powershell/module/microsoft.powershell.core/about/about_environment_variables?view=powershell-7.2
- https://docs.microsoft.com/zh-cn/dotnet/api/system.environment?view=net-6.0
- https://docs.microsoft.com/zh-cn/dotnet/api/system.environmentvariabletarget?view=net-6.0
